# Application Configuration for Hybrid PDF OCR with Intelligent Routing

# General Settings
app:
  name: "Hybrid PDF OCR"
  version: "0.1.0"
  cache_dir: "${HOME}/.cache/hybrid-pdf-ocr"
  log_dir: "${HOME}/.cache/hybrid-pdf-ocr/logs"
  temp_dir: "/tmp/hybrid-pdf-ocr"

# Device Configuration (macOS specific)
device:
  # Options: mps, cpu
  preferred: "mps"
  fallback: "cpu"
  # Thread pool size for CPU operations
  num_workers: 4
  # Process pool size for parallel page processing
  num_processes: 2

# PDF Processing
pdf:
  # DPI for image conversion
  dpi: 300
  # Max pages per batch
  max_pages_per_batch: 10
  # Page range: null for all, or [start, end]
  page_range: null
  # Image format: PNG, JPEG
  image_format: "PNG"

# Model Priority Order (highest to lowest)
model_priority:
  - docai
  - donut
  - trocr
  - tatr
  - pix2tex

# Confidence Thresholds
thresholds:
  # DocAI acceptance threshold
  docai_confidence: 0.85

  # Low confidence threshold - triggers fallback to other models
  low_confidence: 0.5

  # High confidence threshold - accept without validation
  high_confidence: 0.95

  # Table complexity threshold (number of cells)
  simple_table_cells: 50

  # Multi-column detection threshold (column count)
  multi_column_threshold: 2

  # Formula detection confidence
  formula_confidence: 0.7

  # Numeric content detection threshold
  numeric_content_ratio: 0.7

# Language Configuration
language:
  # Supported languages for DocAI
  docai_languages:
    - ko  # Korean
    - en  # English
    - ja  # Japanese
    - zh  # Chinese

  # Fallback language when detection fails
  default_language: en

  # Language detection confidence threshold
  language_confidence: 0.8

# Layout Complexity Detection
layout:
  # Maximum tables per page for "simple" classification
  simple_max_tables: 2

  # Maximum tables per page for "moderate" classification
  moderate_max_tables: 5

  # Text block density threshold (blocks per 1000 pixelsÂ²)
  high_density_threshold: 0.5

  # Column detection parameters
  column_detection:
    min_gap_ratio: 0.05  # Minimum horizontal gap to detect columns
    min_column_width_ratio: 0.3  # Minimum column width relative to page

# Model-Specific Configuration
models:
  docai:
    # DocAI is preferred when:
    # - Confidence >= threshold
    # - Language is supported
    # - Layout is simple to moderate
    enabled: true
    processor_id_ocr: "${DOCAI_PROCESSOR_ID_OCR}"
    processor_id_form: "${DOCAI_PROCESSOR_ID_FORM}"
    project_id: "${GCP_PROJECT}"
    location: "${GCP_LOCATION}"
    timeout_seconds: 120
    max_pages_per_request: 50
    retry_attempts: 3

  donut:
    # Donut is used when:
    # - DocAI confidence is low
    # - Complex multi-column layouts
    # - Many tables present
    enabled: true
    model_name: "naver-clova-ix/donut-base"
    lora_adapter_path: "models/donut_lora"
    use_lora: false
    timeout_seconds: 60
    batch_size: 1
    max_image_size: 2560
    quantization: "fp16"
    max_length: 1024

  trocr:
    # TrOCR ONNX is used for:
    # - Numeric content validation
    # - Code/ID recognition
    # - Date/time parsing
    # - Cross-validation of critical fields
    enabled: true
    model_name: "microsoft/trocr-base-printed"
    onnx_model_path: "models/trocr_int8.onnx"
    timeout_seconds: 20
    use_onnx: true
    onnx_providers:
      - CUDAExecutionProvider
      - CPUExecutionProvider
    content_patterns:
      - numeric
      - date
      - code
      - alphanumeric
    max_length: 512
    batch_size: 4

  tatr:
    # TATR (Table Transformer) is used for:
    # - Table structure recovery
    # - Complex table parsing
    enabled: true
    model_name: "microsoft/table-transformer-detection"
    structure_model: "microsoft/table-transformer-structure-recognition"
    timeout_seconds: 45
    min_table_confidence: 0.7
    cell_detection_threshold: 0.5
    extract_tables: true

  pix2tex:
    # pix2tex is used for:
    # - Mathematical formula extraction
    # - LaTeX generation
    enabled: true
    model_name: "pix2tex/default"
    timeout_seconds: 30
    min_formula_size: 20  # Minimum pixel width/height
    temperature: 0.1  # Sampling temperature
    detect_math: true
    confidence_threshold: 0.6

# Routing Heuristics
routing:
  # Strategy for model selection
  strategy: adaptive  # Options: adaptive, fixed, confidence_based

  # DocAI confidence threshold (when to accept DocAI result)
  docai_conf_threshold: 0.88

  # Engine-specific timeouts (milliseconds)
  donut_timeout_ms: 3000
  trocr_timeout_ms: 2000
  tatr_timeout_ms: 4500

  # TrOCR pattern-based substitution (regex patterns for replacement)
  trocr_replace_patterns:
    - "\\d{3}-\\d{2}-\\d{5}"  # SSN-like patterns
    - "\\d{4}-\\d{2}-\\d{2}"  # Date patterns (YYYY-MM-DD)
    - "\\d{2}/\\d{2}/\\d{4}"  # Date patterns (MM/DD/YYYY)
    - "[A-Z]{2}\\d{6}"        # Code patterns (e.g., AB123456)

  # Prefer table-specific engine for table content
  prefer_table_engine: true

  # Parallel model execution
  parallel_execution: false
  max_parallel_models: 3

  # Per-block routing decisions
  block_level_routing: true

  # Fallback cascade order
  fallback_cascade:
    - docai
    - donut
    - trocr

  # Content-specific routing
  content_routing:
    tables:
      primary: tatr
      fallback: docai
      validation: donut

    formulas:
      primary: pix2tex
      fallback: donut

    numeric:
      primary: trocr
      validation: docai
      substitution_on_mismatch: true

    code:
      primary: trocr
      fallback: donut

    dates:
      primary: trocr
      validation: docai
      format_normalization: true

    general_text:
      primary: docai
      fallback: donut

# Ensemble Configuration
ensemble:
  # Enable ensemble mode (use multiple models)
  enabled: true

  # Ensemble strategy
  strategy: weighted_voting  # Options: voting, weighted_voting, consensus, confidence_max

  # Minimum models for ensemble
  min_models: 2

  # Maximum models for ensemble
  max_models: 3

  # Confidence weight factors
  weights:
    docai: 1.5
    donut: 1.2
    trocr: 1.0
    tatr: 1.3
    pix2tex: 1.1

  # Conflict resolution
  conflict_resolution:
    # How to handle text conflicts
    text_mismatch: use_highest_confidence

    # How to handle bounding box conflicts
    bbox_overlap_threshold: 0.5
    bbox_merge_strategy: union

    # Voting threshold for consensus
    consensus_threshold: 0.6

  # Cross-validation rules
  cross_validation:
    # Validate numeric content across models
    numeric_fields: true

    # Maximum allowed difference for numeric validation
    numeric_tolerance: 0.01

    # Validate dates across models
    date_fields: true

    # Validate table cell counts
    table_structure: true

# Layout Merge Configuration
layout_merge:
  # Reading order detection method
  reading_order_method: spatial_analysis  # Options: spatial_analysis, neural, hybrid

  # Reading direction
  primary_direction: top_to_bottom
  secondary_direction: left_to_right

  # Merge parameters
  merge:
    # Minimum vertical gap to separate paragraphs (relative to font height)
    paragraph_gap_threshold: 1.5

    # Maximum horizontal gap for same line (relative to character width)
    same_line_gap_threshold: 2.0

    # Column detection sensitivity
    column_detection_sensitivity: 0.7

  # Source/confidence labeling
  preserve_metadata:
    model_source: true
    confidence_scores: true
    bounding_boxes: true
    block_types: true
    timestamps: true

# Preprocessing (Simplified Configuration)
preproc:
  # DPI for image conversion
  dpi: 300
  # Enable image enhancement (contrast, denoise, deskew)
  enhance: true

# Preprocessing (Detailed Configuration)
preprocessing:
  # Auto-rotate based on orientation detection
  auto_rotate: true
  # Deskew (straighten) images
  deskew: true
  # Enhance contrast
  enhance_contrast: true
  # Denoise
  denoise: false
  # Binarization threshold (Otsu if null)
  binarization_threshold: null
  # Image preprocessing
  preprocessing:
    # Resize large images
    max_dimension: 4096

    # Image quality enhancement
    enhance_contrast: true
    denoise: true
    deskew: true

    # DPI normalization
    target_dpi: 300

# Postprocessing
postprocessing:
  # Normalize whitespace
  normalize_whitespace: true
  # Fix common OCR errors
  fix_common_errors: true
  # Merge text blocks by reading order
  merge_blocks: true
  # Preserve layout structure
  preserve_layout: true

# Export Options
export:
  # Output formats: txt, json, markdown, docx, searchable_pdf
  formats: ["json", "txt", "searchable_pdf"]
  # Include confidence scores in output
  include_confidence: true
  # Include bounding boxes
  include_bboxes: true
  # Searchable PDF: text layer opacity (0-255, 0=invisible)
  pdf_text_opacity: 0

# Runtime Configuration (Simplified)
runtime:
  # Maximum worker threads for parallel processing
  max_workers: 4
  # Device: mps (Apple Silicon), cpu
  device: "mps"

# Performance Configuration
performance:
  # Cache OCR results
  enable_cache: true
  cache_ttl_seconds: 3600

  # Memory limits
  max_memory_mb: 8192

  # GPU configuration
  use_gpu: true
  gpu_memory_fraction: 0.8

# Cache Configuration
cache:
  enabled: true
  # Cache strategy: content_hash, file_path
  strategy: "content_hash"
  # TTL in seconds (null for no expiration)
  ttl: 3600
  # Max cache size in MB
  max_size_mb: 1024

# Logging Configuration
logging:
  level: INFO  # DEBUG, INFO, WARNING, ERROR, CRITICAL

  # Log routing decisions
  log_routing_decisions: true

  # Log confidence scores
  log_confidence_scores: true

  # Log processing times
  log_timing: true

  # Output format
  format: json

  # Log file rotation
  rotation:
    max_size_mb: 10
    backup_count: 5

  # Audit trail
  audit_enabled: true

  # Filter PII from logs
  filter_pii: true

# Quality Assurance
quality:
  # Minimum acceptable confidence for output
  min_output_confidence: 0.6

  # Flag low-confidence results
  flag_low_confidence: true
  low_confidence_marker: "[?]"

  # Post-processing validation
  validation:
    # Check for common OCR errors
    common_errors: true

    # Spell check (if language model available)
    spell_check: false

    # Format validation (emails, phones, etc.)
    format_validation: true

  # Quality metrics to track
  metrics:
    - average_confidence
    - processing_time
    - model_distribution
    - error_rate
    - coverage

# Error Handling
error_handling:
  # Retry failed requests
  retry_on_failure: true
  max_retries: 3
  retry_delay_seconds: 2
  exponential_backoff: true

  # Fallback behavior
  fallback_on_error: true

  # Continue on partial failures
  partial_failure_mode: continue

  # Error notification
  notify_on_error: false

# Evaluation & Benchmarking
evaluation:
  # Ground truth directory
  ground_truth_dir: "tests/data/ground_truth"

  # Input data directory
  test_data_dir: "tests/data"

  # Output reports directory
  reports_dir: "reports"

  # OCR Metrics: Character Error Rate, Word Error Rate, Accuracy
  metrics:
    - cer
    - wer
    - accuracy

  # Table evaluation: TEDS (Tree Edit Distance based Similarity), Cell F1
  table_metrics:
    - teds
    - cell_f1

  # Performance metrics
  performance_metrics:
    - p95_latency      # 95th percentile latency
    - avg_latency      # Average latency
    - engine_hit_rate  # Engine hit rate (which engine was used)
    - throughput       # Pages per second

  # Error analysis configuration
  error_analysis:
    enabled: true
    # Generate page thumbnails for failed pages
    generate_thumbnails: true
    # Thumbnail size (pixels)
    thumbnail_size: 200
    # Show prediction vs ground truth diff
    show_diff: true
    # Include routing decision reason in error report
    include_routing_reason: true
    # Maximum errors to display
    max_errors_displayed: 50

  # Save predictions for review
  save_predictions: true

  # Output formats
  output_formats:
    - csv    # Metrics in CSV format
    - md     # Markdown report
    - json   # Detailed JSON results

  # Comparison mode (compare multiple models/configs)
  comparison:
    enabled: false
    baseline_model: "docai"
    models_to_compare:
      - donut
      - trocr

# GUI Settings
gui:
  # Window size
  window_width: 1200
  window_height: 800
  # Theme: light, dark, auto
  theme: "auto"
  # Show preview pane
  show_preview: true
  # Auto-save settings
  auto_save_settings: true
